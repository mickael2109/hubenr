{
  "openapi": "3.0.0",
  "info": {
    "title": "HubENR CRM API",
    "description": "API pour la gestion des Leads, Devis (Quotes), Installations, et Reporting pour un mini-CRM.",
    "version": "1.0.0"
  },
  "servers": [
    {
      "url": "http://localhost:3000/api",
      "description": "Serveur Local (Développement)"
    },
    {
      "url": "https://hubenr-dataven-io.onrender.com/api",
      "description": "Serveur de Production (Référence pour le test)"
    }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {
      "UserRegistration": {
        "type": "object",
        "properties": {
          "email": {
            "type": "string",
            "format": "email",
            "example": "john.doe@example.com"
          },
          "name": {
            "type": "string",
            "example": "John Doe"
          },
          "password": {
            "type": "string",
            "example": "AStrongPassword01"
          }
        }
      },
      "UserLogin": {
        "type": "object",
        "properties": {
          "email": {
            "type": "string",
            "format": "email",
            "example": "mik.doe@example.com"
          },
          "password": {
            "type": "string",
            "example": "Mickael0@"
          }
        }
      },
      "LeadCreation": {
        "type": "object",
        "properties": {
          "firstName": {
            "type": "string",
            "example": "Robert"
          },
          "lastName": {
            "type": "string",
            "example": "Prospect"
          },
          "email": {
            "type": "string",
            "format": "email",
            "example": "robert@example.com"
          },
          "phone": {
            "type": "string",
            "example": "0382932323"
          },
          "company": {
            "type": "string",
            "example": "ABC Corp"
          },
          "assignedToUserId": {
            "type": "string",
            "format": "uuid",
            "example": "b42ed38e-e765-4844-80f5-ced67c6ed2a3"
          }
        }
      },
      "LeadUpdate": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "enum": [
              "NEW",
              "CONTACTED",
              "RELANCE",
              "RDV",
              "SENT"
            ],
            "example": "CONTACTED"
          },
          "company": {
            "type": "string",
            "example": "XYZ Inc."
          },
          "phone": {
            "type": "string",
            "example": "0987654321"
          }
        }
      },
      "QuoteItem": {
        "type": "object",
        "properties": {
          "description": {
            "type": "string",
            "example": "Installation solaire 5kW"
          },
          "quantity": {
            "type": "number",
            "format": "integer",
            "example": 2
          },
          "unitPrice": {
            "type": "number",
            "format": "float",
            "example": 50000
          }
        }
      },
      "QuoteCreation": {
        "type": "object",
        "properties": {
          "leadId": {
            "type": "string",
            "format": "uuid",
            "example": "aeceaf8e-7450-4bd7-98ca-c77ed7038571"
          },
          "items": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/QuoteItem"
            }
          }
        }
      },
      "QuoteItemUpdate": {
        "type": "object",
        "properties": {
          "quantity": {
            "type": "number",
            "format": "integer",
            "example": 3
          },
          "unitPrice": {
            "type": "number",
            "format": "float",
            "example": 50
          }
        }
      },
      "QuoteSend": {
        "type": "object",
        "properties": {
          "expiresAt": {
            "type": "string",
            "format": "date-time",
            "example": "2025-12-04T23:59:59.000Z"
          }
        }
      },
      "InstallationCreation": {
        "type": "object",
        "properties": {
          "quoteId": {
            "type": "string",
            "format": "uuid",
            "example": "e15ead10-0eac-4db7-8aa6-79901dd06693"
          },
          "endDate": {
            "type": "string",
            "format": "date-time",
            "example": "2025-11-16T17:31:48.131Z"
          }
        }
      },
      "InstallationUpdate": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "enum": [
              "PREPARATION",
              "INPROGRESS",
              "COMPLETED"
            ],
            "example": "INPROGRESS"
          }
        }
      }
    }
  },
  "paths": {
    "/users/register": {
      "post": {
        "tags": [
          "Users & Auth"
        ],
        "summary": "Enregistre un nouvel utilisateur",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UserRegistration"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Utilisateur créé avec succès."
          },
          "400": {
            "description": "Données invalides."
          }
        }
      }
    },
    "/auth/login": {
      "post": {
        "tags": [
          "Users & Auth"
        ],
        "summary": "Connecte un utilisateur et retourne un jeton d'accès (access token) et un jeton de rafraîchissement (refresh token).",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UserLogin"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Connexion réussie."
          }
        }
      }
    },
    "/auth/me": {
      "get": {
        "tags": [
          "Users & Auth"
        ],
        "summary": "Récupère les informations de l'utilisateur connecté via le JWT.",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Informations utilisateur."
          },
          "401": {
            "description": "Non autorisé (Jeton invalide ou manquant)."
          }
        }
      }
    },
    "/auth/refresh-token": {
      "post": {
        "tags": [
          "Users & Auth"
        ],
        "summary": "Utilise le jeton de rafraîchissement pour obtenir un nouveau jeton d'accès.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "refreshToken": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Nouveau jeton d'accès."
          }
        }
      }
    },
    "/leads": {
      "get": {
        "tags": [
          "Leads"
        ],
        "summary": "Récupère la liste de tous les Leads.",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "status",
            "schema": {
              "type": "string",
              "enum": [
                "NEW",
                "CONTACTED",
                "RELANCE",
                "RDV",
                "SENT"
              ]
            },
            "description": "Filtrer par statut de Lead."
          }
        ],
        "responses": {
          "200": {
            "description": "Liste des Leads."
          }
        }
      },
      "post": {
        "tags": [
          "Leads"
        ],
        "summary": "Crée un nouveau Lead.",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/LeadCreation"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Lead créé."
          }
        }
      }
    },
    "/leads/{leadId}": {
      "parameters": [
        {
          "in": "path",
          "name": "leadId",
          "required": true,
          "schema": {
            "type": "string",
            "format": "uuid"
          },
          "description": "ID du Lead."
        }
      ],
      "get": {
        "tags": [
          "Leads"
        ],
        "summary": "Récupère un Lead par son ID.",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Détails du Lead."
          },
          "404": {
            "description": "Lead non trouvé."
          }
        }
      },
      "put": {
        "tags": [
          "Leads"
        ],
        "summary": "Met à jour un Lead (partiel ou complet).",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/LeadUpdate"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Lead mis à jour."
          },
          "409": {
            "description": "Conflit (ex: email déjà utilisé par un autre lead)."
          }
        }
      },
      "delete": {
        "tags": [
          "Leads"
        ],
        "summary": "Supprime un Lead par son ID.",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "204": {
            "description": "Lead supprimé."
          }
        }
      }
    },
    "/quotes": {
      "get": {
        "tags": [
          "Devis (Quotes)"
        ],
        "summary": "Récupère la liste de tous les Devis.",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "leadId",
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "description": "Filtrer les devis par l'ID du Lead."
          }
        ],
        "responses": {
          "200": {
            "description": "Liste des Devis."
          }
        }
      },
      "post": {
        "tags": [
          "Devis (Quotes)"
        ],
        "summary": "Crée un nouveau Devis rattaché à un Lead (statut DRAFT).",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/QuoteCreation"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Devis créé."
          }
        }
      }
    },
    "/quotes/{quoteId}": {
      "parameters": [
        {
          "in": "path",
          "name": "quoteId",
          "required": true,
          "schema": {
            "type": "string",
            "format": "uuid"
          },
          "description": "ID du Devis."
        }
      ],
      "get": {
        "tags": [
          "Devis (Quotes)"
        ],
        "summary": "Récupère un Devis par son ID.",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Détails du Devis."
          }
        }
      },
      "delete": {
        "tags": [
          "Devis (Quotes)"
        ],
        "summary": "Supprime un Devis.",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "204": {
            "description": "Devis supprimé."
          }
        }
      }
    },
    "/quotes/{quoteId}/send": {
      "post": {
        "tags": [
          "Devis (Quotes)"
        ],
        "summary": "Passe le statut du Devis à SENT et définit une date d'expiration.",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/paths/~1quotes~1{quoteId}/parameters/0"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/QuoteSend"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Statut mis à jour à SENT."
          }
        }
      }
    },
    "/quotes/{quoteId}/sign": {
      "post": {
        "tags": [
          "Devis (Quotes)"
        ],
        "summary": "Simule la signature du Devis. Met à jour le statut à SIGNED et crée une installation (Fonctionnalité 3 & 4).",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/paths/~1quotes~1{quoteId}/parameters/0"
          }
        ],
        "responses": {
          "200": {
            "description": "Statut mis à jour à SIGNED, Installation créée."
          }
        }
      }
    },
    "/quotes/{quoteId}/items": {
      "post": {
        "tags": [
          "Devis (Quotes) - Items"
        ],
        "summary": "Ajoute un article à un Devis (uniquement si le statut est DRAFT).",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "$ref": "#/paths/~1quotes~1{quoteId}/parameters/0"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/QuoteItem"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Article ajouté."
          }
        }
      }
    },
    "/quotes/{quoteId}/items/{itemId}": {
      "parameters": [
        {
          "$ref": "#/paths/~1quotes~1{quoteId}/parameters/0"
        },
        {
          "in": "path",
          "name": "itemId",
          "required": true,
          "schema": {
            "type": "string",
            "format": "uuid"
          },
          "description": "ID de l'article dans le Devis."
        }
      ],
      "put": {
        "tags": [
          "Devis (Quotes) - Items"
        ],
        "summary": "Met à jour un article dans le Devis.",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/QuoteItemUpdate"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Article mis à jour."
          }
        }
      },
      "delete": {
        "tags": [
          "Devis (Quotes) - Items"
        ],
        "summary": "Supprime un article du Devis.",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "204": {
            "description": "Article supprimé."
          }
        }
      }
    },
    "/installations": {
      "get": {
        "tags": [
          "Installations"
        ],
        "summary": "Récupère la liste de toutes les Installations.",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Liste des Installations."
          }
        }
      },
      "post": {
        "tags": [
          "Installations"
        ],
        "summary": "Crée une nouvelle Installation à partir d'un Devis (simulant le besoin après signature).",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/InstallationCreation"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Installation créée."
          }
        }
      }
    },
    "/installations/{installationId}": {
      "parameters": [
        {
          "in": "path",
          "name": "installationId",
          "required": true,
          "schema": {
            "type": "string",
            "format": "uuid"
          },
          "description": "ID de l'Installation."
        }
      ],
      "put": {
        "tags": [
          "Installations"
        ],
        "summary": "Met à jour le statut d'une Installation (PREPARATION, INPROGRESS, COMPLETED).",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/InstallationUpdate"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Installation mise à jour."
          }
        }
      }
    },
    "/webhooks/universign": {
      "post": {
        "tags": [
          "Webhooks"
        ],
        "summary": "Endpoint simulant le webhook de retour de la plateforme de signature (Universign).",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "quoteId": {
                    "type": "string",
                    "format": "uuid"
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "signed",
                      "refused",
                      "expired"
                    ]
                  },
                  "eventData": {
                    "type": "object",
                    "description": "Fichier de preuve ou raison du refus."
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Webhook traité."
          }
        }
      }
    },
    "/reporting/dashboard-stats": {
      "get": {
        "tags": [
          "Reporting"
        ],
        "summary": "Récupère les statistiques pour le tableau de bord (taux de conversion, délai moyen).",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Statistiques du Dashboard."
          }
        }
      }
    },
    "/health": {
        "get": {
            "tags": [
                "Health"
            ],
            "summary": "Vérifie l'état de santé du service.",
            "responses": {
                "200": {
                    "description": "Service en ligne."
                }
            }
        }
    }
  }
}